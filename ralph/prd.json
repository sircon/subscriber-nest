{
  "project": "SubscriberNest",
  "branchName": "ralph/billing",
  "description": "Billing Module with Stripe Integration - Implement comprehensive billing system with Stripe for usage-based subscriptions, monthly billing calculation, subscription management, and account deletion with 30-day grace period",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Billing Subscription Entity",
      "description": "As a developer, I need a database entity to store Stripe subscription information linked to users so we can track subscription status and billing details.",
      "acceptanceCriteria": [
        "Create `BillingSubscription` entity with fields: `id` (UUID), `userId` (FK to User, unique), `stripeCustomerId` (string, unique), `stripeSubscriptionId` (string, unique, nullable), `stripePriceId` (string, nullable), `status` (enum: 'active', 'canceled', 'past_due', 'trialing', 'incomplete', 'incomplete_expired'), `currentPeriodStart` (timestamp, nullable), `currentPeriodEnd` (timestamp, nullable), `cancelAtPeriodEnd` (boolean, default false), `canceledAt` (timestamp, nullable), `createdAt` (timestamp), `updatedAt` (timestamp)",
        "Add `@OneToOne` relationship to `User` entity",
        "Generate and run migration successfully",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create Billing Usage Entity",
      "description": "As a developer, I need a database entity to track monthly subscriber counts for billing calculation so we can charge users correctly at the end of each period.",
      "acceptanceCriteria": [
        "Create `BillingUsage` entity with fields: `id` (UUID), `userId` (FK to User), `billingPeriodStart` (timestamp), `billingPeriodEnd` (timestamp), `maxSubscriberCount` (integer), `calculatedAmount` (decimal, precision 10, scale 2), `stripeInvoiceId` (string, nullable), `status` (enum: 'pending', 'invoiced', 'paid', 'failed'), `createdAt` (timestamp), `updatedAt` (timestamp)",
        "Add `@ManyToOne` relationship to `User` entity",
        "Add unique index on `userId` + `billingPeriodStart` to prevent duplicates",
        "Generate and run migration successfully",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add Stripe Configuration to Backend",
      "description": "As a developer, I need Stripe SDK configured in the backend so we can interact with Stripe APIs for subscription management.",
      "acceptanceCriteria": [
        "Install `stripe` npm package in backend",
        "Add Stripe secret key to environment variables (`STRIPE_SECRET_KEY`)",
        "Add Stripe webhook secret to environment variables (`STRIPE_WEBHOOK_SECRET`)",
        "Create `StripeService` with methods to initialize Stripe client",
        "Service validates Stripe keys are configured on initialization",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create Stripe Service for Customer Management",
      "description": "As a developer, I need a service to create and manage Stripe customers so users can be linked to Stripe billing accounts.",
      "acceptanceCriteria": [
        "Add method `createCustomer(email: string, userId: string): Promise<Stripe.Customer>` to `StripeService`",
        "Method creates Stripe customer with email and metadata containing userId",
        "Method returns Stripe customer object",
        "Handle Stripe API errors appropriately",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create Stripe Service for Subscription Management",
      "description": "As a developer, I need a service to create and manage Stripe subscriptions so users can be billed monthly.",
      "acceptanceCriteria": [
        "Add method `createSubscription(customerId: string): Promise<Stripe.Subscription>` to `StripeService`",
        "Method creates Stripe subscription with monthly billing cycle",
        "Subscription uses metered billing (usage-based pricing)",
        "Method returns Stripe subscription object",
        "Add method `cancelSubscription(subscriptionId: string, cancelAtPeriodEnd: boolean): Promise<Stripe.Subscription>`",
        "Add method `getSubscription(subscriptionId: string): Promise<Stripe.Subscription>`",
        "Handle Stripe API errors appropriately",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create Billing Calculation Service",
      "description": "As a developer, I need a service to calculate billing amounts based on subscriber count using the pricing tier structure.",
      "acceptanceCriteria": [
        "Create `BillingCalculationService` with method `calculateAmount(subscriberCount: number): number`",
        "Pricing logic: $5 for first 10,000 subscribers, then $1 per each additional 10,000 subscribers",
        "Examples: 5k subscribers = $5, 15k subscribers = $6, 25k subscribers = $7, 100k subscribers = $14",
        "Method returns calculated amount in dollars (decimal)",
        "Method handles edge cases (0 subscribers, very large numbers)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create Billing Usage Tracking Service",
      "description": "As a developer, I need a service to track and update the maximum subscriber count during each billing period.",
      "acceptanceCriteria": [
        "Create `BillingUsageService` with method `updateUsage(userId: string, currentSubscriberCount: number): Promise<void>`",
        "Method finds or creates `BillingUsage` record for current billing period (month)",
        "Method updates `maxSubscriberCount` if current count is higher than stored max",
        "Billing period is calendar month (1st to last day of month)",
        "Method calculates billing amount using `BillingCalculationService`",
        "Method updates `calculatedAmount` field",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create Monthly Billing Job Processor",
      "description": "As a developer, I need a scheduled job that runs at the end of each month to charge users based on their usage.",
      "acceptanceCriteria": [
        "Create `BillingProcessor` that extends BullMQ processor",
        "Create scheduled job (cron: runs on 1st day of month at 00:00 UTC) to process monthly billing",
        "Job finds all users with active subscriptions",
        "For each user, job retrieves `BillingUsage` for previous month",
        "Job creates Stripe invoice item with calculated amount",
        "Job finalizes Stripe invoice and charges customer",
        "Job updates `BillingUsage` record with `stripeInvoiceId` and `status: 'invoiced'`",
        "Job creates new `BillingUsage` record for current month",
        "Job handles errors gracefully (logs, retries)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Create Stripe Webhook Handler",
      "description": "As a developer, I need to handle Stripe webhooks to keep subscription status in sync with Stripe.",
      "acceptanceCriteria": [
        "Create `POST /billing/webhook` endpoint in new `BillingController`",
        "Endpoint verifies Stripe webhook signature using `STRIPE_WEBHOOK_SECRET`",
        "Handle webhook events: `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.paid`, `invoice.payment_failed`",
        "Update `BillingSubscription` entity based on webhook events",
        "For subscription updates, sync status, period dates, and cancellation flags",
        "For invoice events, update `BillingUsage` records with payment status",
        "Endpoint returns 200 status for successful processing",
        "Endpoint handles errors and logs appropriately",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Create Stripe Checkout Session Endpoint",
      "description": "As a user, I want to connect my Stripe account during onboarding so I can start using the platform.",
      "acceptanceCriteria": [
        "Add `POST /billing/create-checkout-session` endpoint to `BillingController`",
        "Endpoint requires authentication (use `@UseGuards(AuthGuard)`)",
        "Endpoint creates Stripe Checkout session for subscription",
        "Checkout session uses success URL: `/dashboard/settings?session_id={CHECKOUT_SESSION_ID}`",
        "Checkout session uses cancel URL: `/onboarding/stripe?canceled=true`",
        "Checkout session includes customer email from authenticated user",
        "Endpoint returns `{ url: string }` with checkout session URL",
        "Handle errors appropriately",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create Stripe Portal Session Endpoint",
      "description": "As a user, I want to manage my subscription in Stripe so I can update payment methods, view invoices, and cancel if needed.",
      "acceptanceCriteria": [
        "Add `POST /billing/create-portal-session` endpoint to `BillingController`",
        "Endpoint requires authentication",
        "Endpoint validates user has active Stripe customer",
        "Endpoint creates Stripe Customer Portal session",
        "Portal session return URL: `/dashboard/settings`",
        "Endpoint returns `{ url: string }` with portal session URL",
        "Handle errors appropriately",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create Billing Status Check Endpoint",
      "description": "As a developer, I need an endpoint to check if a user has an active subscription so we can block sync/export functionality.",
      "acceptanceCriteria": [
        "Add `GET /billing/status` endpoint to `BillingController`",
        "Endpoint requires authentication",
        "Endpoint returns `{ hasActiveSubscription: boolean, subscription: BillingSubscription | null, currentPeriodEnd: Date | null }`",
        "`hasActiveSubscription` is true if subscription status is 'active' and not canceled at period end",
        "Returns subscription details if exists",
        "Returns 401 if not authenticated",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create Current Usage Endpoint",
      "description": "As a user, I want to see my current month's subscriber count and estimated billing so I can monitor my usage.",
      "acceptanceCriteria": [
        "Add `GET /billing/usage` endpoint to `BillingController`",
        "Endpoint requires authentication",
        "Endpoint returns current month's `BillingUsage` record with: `maxSubscriberCount`, `calculatedAmount`, `billingPeriodStart`, `billingPeriodEnd`",
        "If no usage record exists for current month, creates one with current subscriber count",
        "Returns 401 if not authenticated",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Create Billing History Endpoint",
      "description": "As a user, I want to see my past billing periods and invoices so I can review my billing history.",
      "acceptanceCriteria": [
        "Add `GET /billing/history` endpoint to `BillingController`",
        "Endpoint requires authentication",
        "Endpoint accepts optional query parameter `limit` (default: 12)",
        "Endpoint returns array of past `BillingUsage` records ordered by `billingPeriodStart` DESC",
        "Each record includes: `billingPeriodStart`, `billingPeriodEnd`, `maxSubscriberCount`, `calculatedAmount`, `status`, `stripeInvoiceId`",
        "Returns 401 if not authenticated",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Add Subscription Check Guard",
      "description": "As a developer, I need a guard to block sync and export endpoints when subscription is inactive.",
      "acceptanceCriteria": [
        "Create `SubscriptionGuard` that implements `CanActivate`",
        "Guard checks if user has active subscription using `BillingSubscriptionService`",
        "Guard allows access if subscription is active and not canceled at period end",
        "Guard allows access if subscription is canceled but `currentPeriodEnd` is in the future (grace period)",
        "Guard throws `ForbiddenException` with message \"Active subscription required\" if subscription is inactive",
        "Apply guard to `POST /esp-connections/:id/sync` endpoint",
        "Apply guard to `GET /esp-connections/:id/subscribers/export` endpoint",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Update Sync Service to Track Billing Usage",
      "description": "As a developer, I need the sync service to update billing usage whenever subscribers are synced.",
      "acceptanceCriteria": [
        "Update `SubscriberSyncService.syncSubscribers()` method",
        "After successful sync, count total subscribers for the user (sum across all ESP connections)",
        "Call `BillingUsageService.updateUsage(userId, totalSubscriberCount)`",
        "Update happens after all subscribers are processed",
        "Update happens even if some individual subscribers fail to process",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Add Stripe Step to Onboarding Flow",
      "description": "As a new user, I want to connect my Stripe account as the final step of onboarding so I can start using the platform.",
      "acceptanceCriteria": [
        "Create new page at `src/app/onboarding/stripe/page.tsx`",
        "Page accessible after API key step in onboarding flow",
        "Page displays: heading \"Connect your payment method\", description explaining billing model, \"Connect Stripe\" button",
        "Button calls `POST /billing/create-checkout-session` endpoint",
        "On success, redirects user to Stripe Checkout URL",
        "After successful checkout, Stripe redirects to `/dashboard/settings?session_id=...`",
        "Settings page verifies session and completes onboarding",
        "If user cancels checkout, shows message and allows retry",
        "Page handles loading and error states",
        "Uses shadcn components (Button, Card)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Update Onboarding Flow to Include Stripe Step",
      "description": "As a developer, I need to update the onboarding flow to require Stripe connection before completing onboarding.",
      "acceptanceCriteria": [
        "Update `src/app/onboarding/api-key/page.tsx` to redirect to `/onboarding/stripe` after ESP connection creation (instead of completing onboarding)",
        "Update onboarding completion logic to check for active subscription",
        "Only mark user as onboarded after Stripe subscription is active",
        "Update middleware to allow access to `/onboarding/stripe` for authenticated but not onboarded users",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Create Billing Settings Page",
      "description": "As a user, I want a settings page to view my billing information, usage, and manage my subscription.",
      "acceptanceCriteria": [
        "Create settings page at `src/app/dashboard/settings/billing/page.tsx`",
        "Page displays current month usage card: shows max subscriber count, calculated amount, billing period dates",
        "Page displays subscription status card: shows subscription status, current period end date, cancel at period end flag (if applicable)",
        "Page displays \"Manage Subscription\" button that opens Stripe Customer Portal",
        "Page displays \"View Invoices\" button that opens Stripe Customer Portal (invoices section)",
        "Page displays billing history table: shows past 12 months with period dates, subscriber count, amount, status, invoice link",
        "Page handles loading and error states",
        "Uses shadcn components (Card, Table, Button)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Add API Client Functions for Billing",
      "description": "As a developer, I need API client functions for all billing endpoints so the frontend can interact with billing features.",
      "acceptanceCriteria": [
        "Add `getBillingStatus()` function to API client",
        "Add `getCurrentUsage()` function to API client",
        "Add `getBillingHistory(limit?: number)` function to API client",
        "Add `createCheckoutSession()` function to API client",
        "Add `createPortalSession()` function to API client",
        "All functions include proper TypeScript types",
        "All functions handle authentication tokens and 401 errors",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Add Account Deletion Entity and Migration",
      "description": "As a developer, I need a way to track account deletion requests with soft delete and grace period.",
      "acceptanceCriteria": [
        "Add `deletedAt` (timestamp, nullable) field to `User` entity",
        "Add `deleteRequestedAt` (timestamp, nullable) field to `User` entity",
        "Generate and run migration successfully",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Create Account Deletion Endpoint",
      "description": "As a user, I want to delete my account and all associated data after a 30-day grace period.",
      "acceptanceCriteria": [
        "Add `POST /account/delete` endpoint to new `AccountController`",
        "Endpoint requires authentication",
        "Endpoint sets `deleteRequestedAt` timestamp on user",
        "Endpoint cancels Stripe subscription immediately (if exists)",
        "Endpoint returns success message",
        "Add scheduled job (runs daily) to check for users with `deleteRequestedAt` older than 30 days",
        "Job hard deletes user and all associated data: ESP connections, subscribers, sync history, billing records",
        "Job cancels Stripe subscription if still active",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Create Account Settings Page with Deletion",
      "description": "As a user, I want to see account settings and have the ability to delete my account.",
      "acceptanceCriteria": [
        "Create account settings page at `src/app/dashboard/settings/account/page.tsx`",
        "Page displays user email (read-only)",
        "Page displays account deletion section with warning message",
        "Page displays \"Delete Account\" button with confirmation dialog",
        "Confirmation dialog explains: account will be deleted after 30 days, data can be exported during grace period, subscription will be canceled immediately",
        "On confirmation, calls `POST /account/delete` endpoint",
        "After deletion request, shows message: \"Account deletion requested. You have 30 days to export your data. Your subscription has been canceled.\"",
        "Page handles loading and error states",
        "Uses shadcn components (Card, Button, Alert, Dialog)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Block Access for Deleted Accounts",
      "description": "As a developer, I need to block access to the platform for users who have requested account deletion.",
      "acceptanceCriteria": [
        "Update `AuthGuard` to check if user has `deleteRequestedAt` set",
        "If `deleteRequestedAt` is set, throw `ForbiddenException` with message \"Account deletion in progress. You can export your data for 30 days.\"",
        "Allow access to export endpoints during grace period",
        "Update middleware to redirect deleted accounts to a deletion notice page",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Update Settings Navigation",
      "description": "As a user, I want to navigate between different settings sections (Billing, Account) from the settings page.",
      "acceptanceCriteria": [
        "Update settings page structure to include navigation tabs/sidebar",
        "Add \"Billing\" tab linking to `/dashboard/settings/billing`",
        "Add \"Account\" tab linking to `/dashboard/settings/account`",
        "Active tab is highlighted",
        "Navigation persists across page loads",
        "Uses shadcn Tabs or similar navigation component",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Handle Stripe Checkout Success",
      "description": "As a user, I want my subscription to be activated after successfully completing Stripe checkout.",
      "acceptanceCriteria": [
        "Update settings page to check for `session_id` query parameter",
        "If `session_id` exists, call Stripe API to retrieve checkout session",
        "Verify session is completed and paid",
        "Create or update `BillingSubscription` record with subscription details",
        "If user is not onboarded, complete onboarding (set `isOnboarded: true`)",
        "Show success message: \"Subscription activated successfully\"",
        "Remove `session_id` from URL after processing",
        "Handle errors gracefully",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Display Subscription Warning for Inactive Users",
      "description": "As a user, I want to see a warning when my subscription is inactive so I know why I can't sync or export.",
      "acceptanceCriteria": [
        "Add subscription status check to dashboard layout",
        "If subscription is inactive, display banner at top of dashboard: \"Your subscription is inactive. Please update your payment method to continue syncing and exporting.\"",
        "Banner includes \"Manage Subscription\" button linking to billing settings",
        "Banner is dismissible (stores dismissal in localStorage)",
        "Banner reappears after 24 hours if subscription still inactive",
        "Uses shadcn Alert component",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Disable Sync and Export Buttons for Inactive Subscription",
      "description": "As a user, I want to see why sync and export buttons are disabled when my subscription is inactive.",
      "acceptanceCriteria": [
        "Update ESP detail page to check subscription status on load",
        "If subscription is inactive, disable \"Sync\" button with tooltip: \"Active subscription required to sync\"",
        "If subscription is inactive, disable \"Export\" button with tooltip: \"Active subscription required to export\"",
        "Buttons show loading state while checking subscription status",
        "Uses shadcn Tooltip component",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    }
  ]
}
