{
  "project": "SubscriberNest",
  "branchName": "ralph/backend-service-split",
  "description": "Backend Service Split and Midnight Sync Cron Job - Split monolithic backend into API and Worker services, create shared package, implement midnight UTC cron job for automatic ESP connection syncing",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Shared Package Directory Structure",
      "description": "As a developer, I need a shared package directory structure so I can organize shared code between API and Worker services.",
      "acceptanceCriteria": [
        "Create `packages/shared` directory in monorepo root",
        "Create `packages/shared/src` directory structure",
        "Create `packages/shared/src/entities/` directory",
        "Create `packages/shared/src/dto/` directory",
        "Create `packages/shared/src/services/` directory",
        "Create `packages/shared/src/events/` directory",
        "Create `packages/shared/src/interfaces/` directory",
        "Create `packages/shared/src/types/` directory",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create Shared Package Configuration",
      "description": "As a developer, I need package.json and TypeScript configuration for the shared package so it can be imported by other services.",
      "acceptanceCriteria": [
        "Create `packages/shared/package.json` with name, version, and proper exports",
        "Create `packages/shared/tsconfig.json` with TypeScript configuration",
        "Configure TypeScript paths/aliases for shared package exports",
        "Update root `package.json` workspaces to include `packages/shared`",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Move Entities to Shared Package",
      "description": "As a developer, I need all TypeORM entities in the shared package so both services can use the same entity definitions.",
      "acceptanceCriteria": [
        "Move all files from `apps/backend/src/entities/` to `packages/shared/src/entities/`",
        "Update all entity imports in old backend to reference shared package",
        "Verify all entities compile correctly in shared package",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Move DTOs to Shared Package",
      "description": "As a developer, I need all DTOs in the shared package so both services can use the same data transfer objects.",
      "acceptanceCriteria": [
        "Move all files from `apps/backend/src/dto/` to `packages/shared/src/dto/`",
        "Update all DTO imports in old backend to reference shared package",
        "Verify all DTOs compile correctly in shared package",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Move Common Services to Shared Package",
      "description": "As a developer, I need common services like EncryptionService in the shared package so both services can use them without duplication.",
      "acceptanceCriteria": [
        "Move `EncryptionService` from `apps/backend/src/services/` to `packages/shared/src/services/`",
        "Update all service imports in old backend to reference shared package",
        "Verify EncryptionService compiles correctly in shared package",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create API Service Directory Structure",
      "description": "As a developer, I need the API service directory structure so I can migrate controllers and services.",
      "acceptanceCriteria": [
        "Create `apps/api` directory",
        "Create `apps/api/src` directory structure",
        "Create `apps/api/src/controllers/` directory",
        "Create `apps/api/src/services/` directory",
        "Create `apps/api/src/guards/` directory",
        "Create `apps/api/src/decorators/` directory",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create API Service Package Configuration",
      "description": "As a developer, I need package.json and TypeScript configuration for the API service so it can run as a NestJS application.",
      "acceptanceCriteria": [
        "Create `apps/api/package.json` with NestJS dependencies",
        "Create `apps/api/tsconfig.json` with TypeScript configuration",
        "Configure imports to reference `packages/shared`",
        "Update root `package.json` workspaces if needed",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Copy Controllers to API Service",
      "description": "As a developer, I need all HTTP controllers in the API service so it can handle API requests.",
      "acceptanceCriteria": [
        "Copy all files from `apps/backend/src/controllers/` to `apps/api/src/controllers/`",
        "Copy `apps/backend/src/auth.controller.ts` to `apps/api/src/auth.controller.ts`",
        "Copy `apps/backend/src/app.controller.ts` to `apps/api/src/app.controller.ts`",
        "Update all imports in controllers to reference shared package entities/DTOs",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Copy API Services to API Service",
      "description": "As a developer, I need API-specific services in the API service so controllers can use them.",
      "acceptanceCriteria": [
        "Copy `SubscriberService` to `apps/api/src/services/`",
        "Copy `SubscriberExportService` to `apps/api/src/services/`",
        "Copy `EspConnectionService` to `apps/api/src/services/`",
        "Copy `AuthService` to `apps/api/src/services/`",
        "Copy `EmailService` to `apps/api/src/services/`",
        "Copy `StripeService` to `apps/api/src/services/`",
        "Copy `BillingSubscriptionService` to `apps/api/src/services/`",
        "Copy `BillingUsageService` to `apps/api/src/services/`",
        "Copy `BillingCalculationService` to `apps/api/src/services/`",
        "Update all imports to reference shared package",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Copy Guards and Decorators to API Service",
      "description": "As a developer, I need guards and decorators in the API service so controllers can use them for authentication.",
      "acceptanceCriteria": [
        "Copy `AuthGuard` from `apps/backend/src/guards/` to `apps/api/src/guards/`",
        "Copy `SubscriptionGuard` from `apps/backend/src/guards/` to `apps/api/src/guards/`",
        "Copy `CurrentUser` decorator from `apps/backend/src/decorators/` to `apps/api/src/decorators/`",
        "Update all imports to reference shared package",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Configure TypeORM in API Service",
      "description": "As a developer, I need TypeORM configured in the API service so it can connect to the database.",
      "acceptanceCriteria": [
        "Create `apps/api/src/app.module.ts` with TypeORM configuration",
        "Import `TypeOrmModule.forRoot()` with database connection settings",
        "Import `TypeOrmModule.forFeature()` with all entities from shared package",
        "Configure database connection from environment variables (DATABASE_*)",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Configure BullMQ Producers in API Service",
      "description": "As a developer, I need BullMQ configured in the API service so it can add jobs to queues (but not process them).",
      "acceptanceCriteria": [
        "Import `BullModule.forRoot()` in API service AppModule with Redis connection",
        "Register all queues using `BullModule.registerQueue()` (subscriber-sync, billing, account-deletion)",
        "Do NOT register any queue processors (only producers)",
        "Configure Redis connection from environment variables (REDIS_*)",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create API Service Main Entry Point",
      "description": "As a developer, I need a main.ts file for the API service so it can start the HTTP server.",
      "acceptanceCriteria": [
        "Create `apps/api/src/main.ts` that bootstraps NestJS application",
        "Configure HTTP server to listen on port from `PORT` env var (default 4000)",
        "Configure CORS if needed",
        "Configure raw body middleware for webhook endpoints",
        "API service starts successfully and listens on configured port",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Create Worker Service Directory Structure",
      "description": "As a developer, I need the worker service directory structure so I can migrate processors and schedulers.",
      "acceptanceCriteria": [
        "Create `apps/worker` directory",
        "Create `apps/worker/src` directory structure",
        "Create `apps/worker/src/processors/` directory",
        "Create `apps/worker/src/services/` directory",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create Worker Service Package Configuration",
      "description": "As a developer, I need package.json and TypeScript configuration for the worker service so it can run as a NestJS application.",
      "acceptanceCriteria": [
        "Create `apps/worker/package.json` with NestJS dependencies including `@nestjs/schedule`",
        "Create `apps/worker/tsconfig.json` with TypeScript configuration",
        "Configure imports to reference `packages/shared`",
        "Update root `package.json` workspaces if needed",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Copy Processors to Worker Service",
      "description": "As a developer, I need all queue processors in the worker service so it can process jobs.",
      "acceptanceCriteria": [
        "Copy `SubscriberSyncProcessor` from `apps/backend/src/processors/` to `apps/worker/src/processors/`",
        "Copy `BillingProcessor` from `apps/backend/src/processors/` to `apps/worker/src/processors/`",
        "Copy `AccountDeletionProcessor` from `apps/backend/src/processors/` to `apps/worker/src/processors/`",
        "Update all imports to reference shared package entities",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Copy Worker Services to Worker Service",
      "description": "As a developer, I need worker-specific services in the worker service so processors can use them.",
      "acceptanceCriteria": [
        "Copy `SubscriberSyncService` to `apps/worker/src/services/`",
        "Copy `SubscriberMapperService` to `apps/worker/src/services/`",
        "Copy `SyncHistoryService` to `apps/worker/src/services/`",
        "Copy `BeehiivConnector` to `apps/worker/src/services/` or `apps/worker/src/connectors/`",
        "Update all imports to reference shared package",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Configure TypeORM in Worker Service",
      "description": "As a developer, I need TypeORM configured in the worker service so it can connect to the database.",
      "acceptanceCriteria": [
        "Create `apps/worker/src/app.module.ts` with TypeORM configuration",
        "Import `TypeOrmModule.forRoot()` with database connection settings",
        "Import `TypeOrmModule.forFeature()` with all entities from shared package",
        "Configure database connection from environment variables (DATABASE_*)",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Configure BullMQ Workers in Worker Service",
      "description": "As a developer, I need BullMQ configured in the worker service so it can process jobs from queues.",
      "acceptanceCriteria": [
        "Import `BullModule.forRoot()` in worker service AppModule with Redis connection",
        "Register all queues using `BullModule.registerQueue()` with retry configuration",
        "Register all queue processors in AppModule providers",
        "Configure Redis connection from environment variables (REDIS_*)",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Install and Configure NestJS Schedule Module",
      "description": "As a developer, I need the NestJS Schedule module configured in the worker service so I can create cron jobs.",
      "acceptanceCriteria": [
        "Install `@nestjs/schedule` package in `apps/worker`",
        "Import `ScheduleModule.forRoot()` in worker service AppModule",
        "Verify schedule module is properly initialized",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Create Worker Service Main Entry Point",
      "description": "As a developer, I need a main.ts file for the worker service so it can start processing jobs (no HTTP server).",
      "acceptanceCriteria": [
        "Create `apps/worker/src/main.ts` that bootstraps NestJS application",
        "Do NOT create HTTP server (no `app.listen()` call)",
        "Worker service starts successfully and begins processing jobs",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Create Event Classes in Shared Package",
      "description": "As a developer, I need event classes/interfaces in the shared package so both services can use them for communication.",
      "acceptanceCriteria": [
        "Create `packages/shared/src/events/sync-requested.event.ts`",
        "Define `SyncRequestedEvent` class with `espConnectionId` and `userId` properties",
        "Export event class from shared package",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Install Event Emitter in API and Worker Services",
      "description": "As a developer, I need event emitter packages installed in both services so they can communicate via events.",
      "acceptanceCriteria": [
        "Install `@nestjs/event-emitter` package in `apps/api`",
        "Install `@nestjs/event-emitter` package in `apps/worker`",
        "Import `EventEmitterModule.forRoot()` in API service AppModule",
        "Import `EventEmitterModule.forRoot()` in worker service AppModule",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Update API Service to Publish Sync Events",
      "description": "As a user, I want to trigger manual syncs from the API, which should publish events for the worker service to process.",
      "acceptanceCriteria": [
        "Update `EspConnectionController.triggerSync()` to inject `EventEmitter2`",
        "Publish `SyncRequestedEvent` with `espConnectionId` and `userId` when sync is triggered",
        "Remove direct queue job addition from API controller",
        "API service still returns immediate response (202 Accepted)",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Create Worker Service Event Listener",
      "description": "As a developer, I need the worker service to subscribe to sync events and add jobs to the queue.",
      "acceptanceCriteria": [
        "Create event listener service in worker service that subscribes to `SyncRequestedEvent`",
        "Listener uses `@OnEvent('SyncRequestedEvent')` decorator",
        "Listener adds `sync-publication` job to `subscriber-sync` queue when event is received",
        "Listener logs received events",
        "Register listener service in worker service AppModule providers",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Create Midnight Sync Scheduler Service",
      "description": "As a system, I need a cron job that runs every midnight UTC to automatically queue all active ESP connections for syncing.",
      "acceptanceCriteria": [
        "Create `SyncSchedulerService` in `apps/worker/src/services/`",
        "Use `@Cron('0 0 * * *', { timeZone: 'UTC' })` decorator for midnight UTC schedule",
        "Service queries database for all ESP connections where `status = 'active'`",
        "For each active connection, adds a `sync-publication` job to `subscriber-sync` queue",
        "Logs number of connections queued for sync",
        "Handles errors gracefully (logs but doesn't crash)",
        "Service is registered in worker service AppModule providers",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Move Billing Scheduler to Worker Service",
      "description": "As a developer, I need the billing scheduler in the worker service so it can run cron jobs.",
      "acceptanceCriteria": [
        "Move `BillingSchedulerService` from `apps/backend/src/services/` to `apps/worker/src/services/`",
        "Update all imports to reference shared package",
        "Register service in worker service AppModule providers",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Convert Billing Scheduler to Use Cron Decorator",
      "description": "As a developer, I need the billing scheduler to use `@nestjs/schedule` cron decorator instead of BullMQ repeatable jobs.",
      "acceptanceCriteria": [
        "Remove `OnModuleInit` interface from `BillingSchedulerService`",
        "Remove BullMQ repeatable job scheduling logic from `onModuleInit()`",
        "Add `@Cron('0 0 1 * *', { timeZone: 'UTC' })` decorator to method that runs monthly billing",
        "Method runs on 1st day of each month at 00:00 UTC",
        "Verify cron job still runs at correct time",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Move Account Deletion Scheduler to Worker Service",
      "description": "As a developer, I need the account deletion scheduler in the worker service so it can run cron jobs.",
      "acceptanceCriteria": [
        "Move `AccountDeletionSchedulerService` from `apps/backend/src/services/` to `apps/worker/src/services/`",
        "Update all imports to reference shared package",
        "Register service in worker service AppModule providers",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Convert Account Deletion Scheduler to Use Cron Decorator",
      "description": "As a developer, I need the account deletion scheduler to use `@nestjs/schedule` cron decorator instead of BullMQ repeatable jobs.",
      "acceptanceCriteria": [
        "Remove `OnModuleInit` interface from `AccountDeletionSchedulerService`",
        "Remove BullMQ repeatable job scheduling logic from `onModuleInit()`",
        "Add `@Cron('0 0 * * *', { timeZone: 'UTC' })` decorator to method that runs account deletion",
        "Method runs daily at 00:00 UTC",
        "Verify cron job still runs at correct time",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "Update Turbo Configuration for New Services",
      "description": "As a developer, I need the monorepo build system to recognize and build the new API and Worker services.",
      "acceptanceCriteria": [
        "Update `turbo.json` to include `apps/api` and `apps/worker` in build tasks",
        "Verify `turbo run build` builds both services successfully",
        "Verify `turbo run dev` can run both services simultaneously",
        "Typecheck passes"
      ],
      "priority": 31,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-032",
      "title": "Create Environment Configuration Files",
      "description": "As a developer, I need environment variable examples for both services so they can run independently.",
      "acceptanceCriteria": [
        "Create `apps/api/.env.example` with API-specific env vars",
        "Create `apps/worker/.env.example` with worker-specific env vars",
        "Document which env vars are shared (DATABASE_*, REDIS_*) vs service-specific",
        "Both services can read from `.env` files independently",
        "Typecheck passes"
      ],
      "priority": 32,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Update Documentation for New Service Structure",
      "description": "As a developer, I need documentation updated to reflect the new service structure.",
      "acceptanceCriteria": [
        "Update root `README.md` with new service structure (API and Worker)",
        "Document how to run both services independently",
        "Document shared package usage",
        "Update any AGENTS.md files if they reference old backend structure",
        "Typecheck passes"
      ],
      "priority": 33,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Verify API Service Handles All Endpoints",
      "description": "As a developer, I need to verify the API service handles all HTTP endpoints correctly before removing old backend.",
      "acceptanceCriteria": [
        "Verify all controllers are registered in API service AppModule",
        "Verify all services are registered in API service AppModule",
        "Verify API service starts without errors",
        "Verify API service responds to HTTP requests on configured port",
        "Typecheck passes"
      ],
      "priority": 34,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-035",
      "title": "Verify Worker Service Processes All Queues",
      "description": "As a developer, I need to verify the worker service processes all queue jobs correctly before removing old backend.",
      "acceptanceCriteria": [
        "Verify all processors are registered in worker service AppModule",
        "Verify all queues are registered in worker service AppModule",
        "Verify worker service starts without errors",
        "Verify worker service processes jobs from all queues",
        "Typecheck passes"
      ],
      "priority": 35,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-036",
      "title": "Verify Cron Jobs Run Correctly",
      "description": "As a developer, I need to verify all cron jobs run correctly in the worker service before removing old backend.",
      "acceptanceCriteria": [
        "Verify midnight sync scheduler cron job is registered",
        "Verify billing scheduler cron job is registered",
        "Verify account deletion scheduler cron job is registered",
        "Verify all cron jobs use correct schedule patterns",
        "Typecheck passes"
      ],
      "priority": 36,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-037",
      "title": "Remove Old Backend Application",
      "description": "As a developer, I need the old monolithic backend removed after migration is complete and verified.",
      "acceptanceCriteria": [
        "Remove `apps/backend` directory",
        "Update any documentation referencing old backend path",
        "Update CI/CD pipelines if they reference old backend path",
        "Verify no remaining references to old backend in codebase",
        "Typecheck passes"
      ],
      "priority": 37,
      "passes": false,
      "notes": ""
    }
  ]
}
