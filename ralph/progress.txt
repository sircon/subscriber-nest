# Ralph Progress Log
Started: Sun Jan 18 09:32:48 CET 2026

## Codebase Patterns
- TypeORM entities use `@Entity`, `@Column`, and relationship decorators (`@ManyToOne`, `@OneToMany`)
- Enums are defined at the top of entity files and exported for reuse
- Entity IDs use UUID type with `@PrimaryGeneratedColumn('uuid')`
- Migrations use DO $$ BEGIN ... EXCEPTION WHEN duplicate_object pattern for idempotent enum creation
- Foreign key relationships use `@JoinColumn({ name: 'columnName' })` with explicit column naming
- Migration files are timestamped and must be in `src/migrations/` (compiled to `dist/migrations/`)
- Use `columnExists` check pattern to make migrations idempotent: `table?.columns.find((col) => col.name === 'columnName')`
- Always run `turbo run build --filter=backend` before running migrations
- Migration command: `cd apps/backend && yarn db:migrate`
- shadcn CLI generates code with tabs - always convert to spaces to avoid linting errors
- When fetching data for dashboard/overview pages, use Promise.all to fetch multiple endpoints in parallel

---

## 2026-01-18 09:33 - US-001
- Created SyncHistory entity with all required fields (id, espConnectionId, status, startedAt, completedAt, errorMessage, createdAt)
- Added SyncHistoryStatus enum with 'success' and 'failed' values
- Added @ManyToOne relationship from SyncHistory to EspConnection
- Updated EspConnection entity to include @OneToMany relationship to SyncHistory
- Created migration 1737220000000-CreateSyncHistory.ts to create sync_history table with foreign key constraint
- Made existing AddSyncStatusToEspConnection migration idempotent by adding column existence check
- Files changed:
  - `apps/backend/src/entities/sync-history.entity.ts` - New entity file
  - `apps/backend/src/entities/esp-connection.entity.ts` - Added import and syncHistory relationship
  - `apps/backend/src/migrations/1737220000000-CreateSyncHistory.ts` - New migration file
  - `apps/backend/src/migrations/1737200000000-AddSyncStatusToEspConnection.ts` - Added idempotency check
- **Learnings for future iterations:**
  - The data-source.ts uses `src/**/*.entity.ts` pattern to auto-discover entities
  - When adding relationships, both entities need to be updated (ManyToOne side and OneToMany side)
  - Foreign key CASCADE delete ensures sync history is removed when connection is deleted
  - Existing migrations may need idempotency fixes if database already has changes applied
  - Migration timestamps should be sequential and higher than existing migrations
---

## 2026-01-18 10:15 - US-002
- Updated SubscriberSyncProcessor to create SyncHistory records for tracking sync operations
- Added SyncHistory repository injection to the processor
- Created sync history record at job start with status: 'success' and startedAt timestamp
- Updated sync history with completedAt timestamp when sync completes successfully
- Updated sync history with status: 'failed', completedAt, and errorMessage when sync fails after all retries
- Used BullMQ's job.attemptsMade and job.opts.attempts to detect final retry attempt
- Files changed:
  - `apps/backend/src/processors/subscriber-sync.processor.ts` - Added sync history tracking
- **Learnings for future iterations:**
  - BullMQ jobs have `attemptsMade` and `opts.attempts` properties to track retry attempts
  - When a job will be retried, we should only record final failure after all retries exhausted
  - Repository injection in processors follows same pattern as in services/controllers
  - Optimistic approach: Create sync history with 'success' status, update to 'failed' only if needed
  - Always wrap database updates in try-catch to prevent processor failures from cascading
---

## 2026-01-18 15:30 - US-003
- Created SyncHistoryService with findByEspConnection method
- Method queries sync history records for a specific ESP connection
- Returns records ordered by startedAt DESC (most recent first)
- Optional limit parameter defaults to 50 if not provided
- Includes ESP connection relationship in query using relations: ['espConnection']
- Registered SyncHistory entity in TypeOrmModule.forFeature()
- Registered SyncHistoryService in AppModule providers
- Files changed:
  - `apps/backend/src/services/sync-history.service.ts` - New service file
  - `apps/backend/src/app.module.ts` - Added SyncHistory entity and SyncHistoryService registration
- **Learnings for future iterations:**
  - Services follow standard NestJS pattern: @Injectable() decorator, constructor injection
  - Repository injection uses @InjectRepository(Entity) pattern
  - TypeORM find() options: where (filters), relations (eager load), order (sorting), take (limit)
  - Default parameter values in TypeScript: `limit: number = 50` syntax
  - Services must be registered in AppModule providers array to be injectable
  - Entities must be in TypeOrmModule.forFeature() array to inject their repositories
---

## 2026-01-18 18:00 - US-004
- Added GET /esp-connections/:id/sync-history endpoint to EspConnectionController
- Endpoint accepts optional query parameter 'limit' (default: 50)
- Validates ESP connection exists and belongs to requesting user via espConnectionService.findById()
- Returns array of sync history records without espConnection relation to avoid exposing sensitive data
- Follows existing error handling pattern: NotFoundException (404), BadRequestException → ForbiddenException (403)
- Uses Omit<SyncHistory, 'espConnection'>[] return type to properly type the response
- Files changed:
  - `apps/backend/src/controllers/esp-connection.controller.ts` - Added sync history endpoint
- **Learnings for future iterations:**
  - Controllers must import Query decorator for query parameters
  - Query parameters in NestJS can be optional by using `@Query('param') param?: type`
  - Required parameters decorated with @CurrentUser or @Param must come before optional @Query parameters
  - When removing fields from returned objects, use Omit<Type, 'field'>[] for proper typing
  - Controller error handling pattern: validate ownership first, then return appropriate 403/404 errors
  - SyncHistoryService was already registered in AppModule, so no module changes needed
---

## 2026-01-18 21:30 - US-005
- Added GET /esp-connections/:id/subscribers endpoint to EspConnectionController
- Created findByEspConnectionPaginated method in SubscriberService
- Endpoint accepts query parameters: page (default: 1), limit (default: 50), status (optional filter)
- Returns paginated response with data, total, page, limit, and totalPages
- Subscribers returned with maskedEmail (encryptedEmail excluded for security)
- Validates ESP connection exists and belongs to requesting user
- Follows existing error handling pattern: NotFoundException (404), BadRequestException → ForbiddenException (403)
- Files changed:
  - `apps/backend/src/services/subscriber.service.ts` - Added paginated query method
  - `apps/backend/src/controllers/esp-connection.controller.ts` - Added subscribers endpoint and injected SubscriberService
- **Learnings for future iterations:**
  - Paginated responses follow pattern: `{ data: T[], total, page, limit, totalPages }`
  - Use TypeORM skip/take for pagination: `skip: (page - 1) * limit, take: limit`
  - Calculate totalPages: `Math.ceil(total / limit)`
  - When filtering is optional, build where clause conditionally: `if (status) where.status = status`
  - Remove sensitive fields from responses by destructuring: `const { encryptedEmail, ...data } = subscriber`
  - Service injection in controllers: add to constructor parameters and import service class
  - SubscriberService was already registered in AppModule, so no module changes needed
---

## 2026-01-18 23:45 - US-006
- Created new SubscriberController with POST /subscribers/:id/unmask endpoint
- Endpoint validates subscriber exists and belongs to a connection owned by requesting user
- Fetches subscriber with espConnection relation to validate ownership via userId comparison
- Uses EncryptionService.decrypt() to decrypt the encryptedEmail field
- Returns { email: string } with decrypted email
- Follows existing error handling pattern: NotFoundException (404), ForbiddenException (403)
- Registered SubscriberController in AppModule controllers array
- Files changed:
  - `apps/backend/src/controllers/subscriber.controller.ts` - New controller file
  - `apps/backend/src/app.module.ts` - Added SubscriberController registration
- **Learnings for future iterations:**
  - When validating ownership through a relationship, use relations: ['espConnection'] in query
  - Compare espConnection.userId with current user.id for ownership validation
  - EncryptionService.decrypt() throws errors that should be caught and returned as 500
  - New controllers must be both imported and added to controllers array in AppModule
  - Subscriber entity already registered in TypeOrmModule.forFeature(), so repository injection works
  - Pattern for sensitive operations: fetch with relations, validate ownership, perform operation, handle errors
---

## 2026-01-19 01:00 - US-007
- Added GET /esp-connections/:id/subscribers/export endpoint to EspConnectionController
- Endpoint accepts query parameter 'format' (csv, json, xlsx) with default 'csv'
- Installed exceljs package for Excel file generation (v4.4.0)
- Created SubscriberExportService with export methods for each format
- Service decrypts all subscriber emails using EncryptionService
- Service flattens metadata fields with 'metadata_' prefix for export
- CSV export: Manual implementation with proper escaping for quotes, commas, newlines
- JSON export: Pretty-printed JSON with 2-space indentation
- Excel export: Uses exceljs to create workbook with styled headers and formatted data
- Returns StreamableFile with appropriate Content-Type and Content-Disposition headers
- Filename format: subscribers-{espType}-{date}.{ext}
- Follows existing error handling pattern: NotFoundException (404), ForbiddenException (403), BadRequestException (400)
- Registered SubscriberExportService in AppModule providers
- Files changed:
  - `apps/backend/src/services/subscriber-export.service.ts` - New export service
  - `apps/backend/src/controllers/esp-connection.controller.ts` - Added export endpoint
  - `apps/backend/src/app.module.ts` - Registered export service
  - `apps/backend/package.json` - Added exceljs dependency
  - `yarn.lock` - Updated with exceljs and dependencies
- **Learnings for future iterations:**
  - StreamableFile from @nestjs/common is used for file downloads
  - Use @Res({ passthrough: true }) to set response headers while returning StreamableFile
  - Response.set() sets multiple headers at once (Content-Type, Content-Disposition)
  - Content-Disposition header format: `attachment; filename="name.ext"`
  - Excel MIME type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  - CSV MIME type: 'text/csv'
  - exceljs Workbook.xlsx.writeBuffer() returns ArrayBuffer, convert to Buffer with Buffer.from()
  - For CSV escaping: wrap in quotes if contains comma/quote/newline, escape quotes by doubling them
  - Metadata fields should be flattened to top-level fields for export (not nested objects)
  - ExcelJS allows setting column width and styling headers (bold font)
---

## 2026-01-19 01:30 - US-008
- Created new DashboardController with GET /dashboard/stats endpoint
- Endpoint returns dashboard statistics: totalEspConnections, totalSubscribers, lastSyncTime
- Counts all ESP connections for authenticated user using espConnectionRepository.count()
- Fetches user's connection IDs first, then queries subscribers and sync history based on those IDs
- totalSubscribers counts across all user's connections using IN query pattern
- lastSyncTime finds most recent completedAt from sync history ordered DESC
- Returns null for lastSyncTime if no syncs completed yet
- Protected with AuthGuard to ensure authentication (returns 401 if not authenticated)
- Registered DashboardController in AppModule controllers array
- Files changed:
  - `apps/backend/src/controllers/dashboard.controller.ts` - New dashboard controller
  - `apps/backend/src/app.module.ts` - Added DashboardController registration
- **Learnings for future iterations:**
  - When querying across multiple related entities, first fetch primary IDs then use IN queries
  - TypeORM count() with where clause: use array of objects for OR conditions (IN equivalent)
  - TypeORM findOne() with order: use { field: 'DESC' } to get most recent record
  - Return null for optional timestamps when no data exists (not undefined)
  - Dashboard stats endpoints typically aggregate data across multiple tables
  - Direct repository injection in controllers is acceptable for simple aggregation queries
---

## 2026-01-19 02:00 - US-009
- Installed @tanstack/react-table v8.21.3 for data table functionality
- Added shadcn UI components using shadcn CLI: table, dropdown-menu
- Additional shadcn components installed as dependencies: separator, sheet, tooltip
- Note: xlsx/papaparse not installed as backend handles all export generation (US-007)
- Note: Sidebar component will be manually created in US-010 using existing components
- Updated tailwind.config.ts with sidebar animations and CSS variables
- Updated globals.css with additional CSS variables for sidebar styling
- Reinstalled dependencies from root to resolve workspace linking issues
- Frontend build passes successfully with all new dependencies
- Files changed:
  - `apps/frontend/package.json` - Added @tanstack/react-table and radix-ui dependencies
  - `apps/frontend/src/components/ui/table.tsx` - New table component
  - `apps/frontend/src/components/ui/dropdown-menu.tsx` - New dropdown-menu component
  - `apps/frontend/src/components/ui/separator.tsx` - New separator component
  - `apps/frontend/src/components/ui/sheet.tsx` - New sheet component (useful for mobile sidebar)
  - `apps/frontend/src/components/ui/tooltip.tsx` - New tooltip component
  - `apps/frontend/tailwind.config.ts` - Added sidebar animations and keyframes
  - `apps/frontend/src/app/globals.css` - Added CSS variables for sidebar colors
  - `yarn.lock` - Updated with new dependencies
- **Learnings for future iterations:**
  - shadcn CLI command: `npx shadcn@latest add <component> --yes` to skip prompts
  - shadcn components automatically install required radix-ui peer dependencies
  - Yarn workspace requires reinstalling from root after adding dependencies to child packages
  - Sheet component can be used as a mobile-friendly sidebar alternative
  - Separator component useful for dividing sections in sidebars/menus
  - Backend handling exports means frontend doesn't need xlsx/papaparse libraries
---

## 2026-01-19 03:00 - US-010
- Created dashboard layout component at src/app/dashboard/layout.tsx
- Layout wraps all /dashboard/* routes with persistent sidebar navigation
- Sidebar features:
  - Fixed width (~256px) left sidebar on desktop
  - "Connect New ESP" button at top (links to /onboarding)
  - ESP connections list with ESP name and publication ID
  - Active ESP connection highlighted based on pathname
  - Settings button at bottom (links to /dashboard/settings)
- Responsive design:
  - Desktop: Fixed sidebar visible at all times
  - Mobile: Hamburger menu button triggers Sheet component overlay
  - Sheet component slides in from left on mobile
- Fetches ESP connections from API on mount
- Uses lucide-react icons: Menu, Plus, Settings, Database
- Active state uses pathname comparison to highlight current ESP
- Sidebar content shared between desktop and mobile views (DRY pattern)
- Files changed:
  - `apps/frontend/src/app/dashboard/layout.tsx` - New dashboard layout
- **Learnings for future iterations:**
  - Next.js App Router layouts wrap all child routes in that directory
  - Use pathname from usePathname() to highlight active navigation items
  - Sheet component is perfect for mobile-friendly sidebars
  - Fixed sidebar on desktop: `md:fixed md:inset-y-0` with matching `md:ml-64` on main content
  - Hamburger menu should be `fixed` with high z-index to stay visible
  - Extract shared sidebar content into separate component to DRY between desktop/mobile
  - useEffect with token dependency to refetch connections when auth state changes
  - Close mobile sidebar on navigation by calling setMobileOpen(false) in onClick handlers
---

## 2026-01-19 04:00 - US-011
- Created dashboard overview page at apps/frontend/src/app/dashboard/page.tsx
- Replaced existing dashboard page with new overview design
- Implemented three stats cards displaying:
  - Total ESPs count from dashboard stats endpoint
  - Total Subscribers count from dashboard stats endpoint
  - Last Sync time with relative time formatting ("X mins ago", "Never", etc.)
- Added sync history table below stats cards with columns:
  - ESP Name (includes ESP type and publication ID)
  - Status (badge component: green for success, red for failed)
  - Started At (formatted date/time)
  - Completed At (formatted date/time)
  - Error (only shown when status is 'failed', truncated with title tooltip)
- Fetches sync history for all ESP connections in parallel and merges them
- Sorts merged sync history by startedAt DESC and limits to 50 records
- Implemented loading state with skeleton animation
- Implemented error state with error message display
- Added Badge component using shadcn CLI
- Added API client functions:
  - dashboardApi.getStats() - GET /dashboard/stats
  - espConnectionApi.getSyncHistory() - GET /esp-connections/:id/sync-history
- Added TypeScript interfaces: DashboardStats, SyncHistory, SyncHistoryWithEsp
- Fixed linting issues in tailwind.config.ts (converted tabs to spaces from shadcn)
- Files changed:
  - apps/frontend/src/app/dashboard/page.tsx - New dashboard overview implementation
  - apps/frontend/src/lib/api.ts - Added dashboard and sync history API functions
  - apps/frontend/src/components/ui/badge.tsx - New badge component
  - apps/frontend/tailwind.config.ts - Fixed mixed spaces/tabs linting errors
- **Learnings for future iterations:**
  - Dashboard fetches data from multiple endpoints: fetch stats and connections in parallel with Promise.all
  - When aggregating data across multiple connections, map over connections and fetch data in parallel
  - Use .flat() to flatten array of arrays, then sort and slice for final result
  - Silent error handling for individual connection sync history (return empty array) prevents one failing connection from breaking entire dashboard
  - Relative time formatting improves UX: "X mins ago" > full timestamp for recent syncs
  - Badge component with custom className can override default colors (e.g., bg-green-500 for success)
  - Error messages in table cells should be truncated with title attribute for hover tooltip
  - Use max-w-xs and truncate classes for long text in table cells
  - shadcn CLI generates code with tabs, which causes linting errors - convert to spaces
  - Loading state should match final layout structure (3 cards + table) for better UX
---

## 2026-01-19 06:00 - US-012
- Created ESP detail page at apps/frontend/src/app/dashboard/esp/[id]/page.tsx
- Added API client functions for ESP detail page functionality:
  - espConnectionApi.getConnection(connectionId) - GET /esp-connections/:id
  - espConnectionApi.getSubscribers(connectionId, page, limit, status) - GET /esp-connections/:id/subscribers
- Added TypeScript interfaces: Subscriber, PaginatedSubscribers
- Page displays 4 info cards showing ESP connection metrics:
  - Card 1: List Size (total subscriber count)
  - Card 2: Last Sync (timestamp and status badge)
  - Card 3: Connection Status (syncStatus and status)
  - Card 4: Subscriber Breakdown (active vs unsubscribed count)
- Implemented paginated subscriber table with columns:
  - Email (masked, font-mono styling)
  - First Name (with fallback to '-')
  - Last Name (with fallback to '-')
  - Status (badge component with color coding)
  - Subscribed At (formatted date)
  - Actions (Unmask button - disabled placeholder for US-013)
- Pagination controls at bottom with Previous/Next buttons
- Uses URL search params for pagination state (?page=1&limit=50)
- Page fetches connection, sync history (limit 1), and subscribers in parallel using Promise.all
- Implemented loading state with skeleton animation (matches layout structure)
- Implemented error state with error message display
- Responsive grid layout for info cards (1/2/4 columns on mobile/tablet/desktop)
- Files changed:
  - apps/frontend/src/app/dashboard/esp/[id]/page.tsx - New ESP detail page
  - apps/frontend/src/lib/api.ts - Added getConnection and getSubscribers API functions
- **Learnings for future iterations:**
  - When creating dynamic routes in Next.js App Router, use [param] syntax in directory name
  - useParams() returns route parameters, useSearchParams() returns URL query parameters
  - Parallel data fetching pattern: Promise.all([connection, syncHistory, subscribers])
  - Fetch only latest sync (limit: 1) for "Last Sync" card to minimize data transfer
  - URLSearchParams.toString() returns empty string if no params, so check before adding '?'
  - router.push() with new search params preserves other params using searchParams.toString()
  - Calculate active/unsubscribed counts from current page data (subscribers.data.filter)
  - Show '-' for null/undefined values in table cells instead of empty cells
  - Pagination info format: "Showing X to Y of Z subscribers" with calculated ranges
  - Disable pagination buttons at edges (currentPage === 1, currentPage === totalPages)
  - Use font-mono class for masked email display to ensure consistent character width
  - Badge colors: green for success/active, red for failed/bounced, gray for unsubscribed
  - Loading skeleton should match final layout structure for better perceived performance
  - Unmask button is disabled in US-012, will be implemented in US-013
---
