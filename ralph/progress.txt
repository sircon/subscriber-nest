# Ralph Progress Log
Started: Sun Jan 18 21:49:22 CET 2026
---

## Codebase Patterns
- Use `CREATE TABLE IF NOT EXISTS` and `CREATE INDEX IF NOT EXISTS` in migrations for idempotency
- For foreign keys in migrations, use `DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = '...') THEN ... END IF; END $$;` pattern to avoid constraint conflicts
- Migrations use raw SQL queries with IF NOT EXISTS checks rather than TypeORM's createTable/createForeignKey methods for better control
- Entity files use TypeORM decorators: `@Entity()`, `@PrimaryGeneratedColumn('uuid')`, `@Column()`, `@ManyToOne()`, `@JoinColumn()`, `@Index()`
- Always register new entities in `app.module.ts` `TypeOrmModule.forFeature([...])` array
- Run `nest build` before `migration:run` because migrations are compiled to `dist/migrations/`

## Sun Jan 18 21:50:52 CET 2026 - US-001
- Created OAuthState entity with all required fields (id, userId, espType, state, redirectUri, expiresAt, createdAt)
- Added unique index on `state` field and composite index on `userId` and `espType` for cleanup queries
- Created migration file `1768744000000-CreateOAuthState.ts` using IF NOT EXISTS patterns for idempotency
- Updated `app.module.ts` to include OAuthState entity in TypeOrmModule.forFeature
- Migration executed successfully
- Files changed:
  - `apps/backend/src/entities/oauth-state.entity.ts` (new)
  - `apps/backend/src/migrations/1768744000000-CreateOAuthState.ts` (new)
  - `apps/backend/src/app.module.ts` (updated)
- **Learnings for future iterations:**
  - This codebase uses raw SQL with IF NOT EXISTS patterns in newer migrations (like CreateBillingUsage) rather than TypeORM's createTable/createForeignKey methods
  - Foreign key constraints need explicit IF NOT EXISTS checks using `DO $$ BEGIN ... IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = '...') ... END $$;` pattern
  - The `esp_type_enum` already exists from previous migrations, so we can reuse it for OAuthState entity
  - Indexes can use `CREATE INDEX IF NOT EXISTS` directly in SQL
  - Always use `CREATE TABLE IF NOT EXISTS` to handle cases where table might already exist (e.g., from synchronize mode in development)
---
