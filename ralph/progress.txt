# Ralph Progress Log
Started: Sun Jan 18 09:32:48 CET 2026

## Codebase Patterns
- TypeORM entities use `@Entity`, `@Column`, and relationship decorators (`@ManyToOne`, `@OneToMany`)
- Enums are defined at the top of entity files and exported for reuse
- Entity IDs use UUID type with `@PrimaryGeneratedColumn('uuid')`
- Migrations use DO $$ BEGIN ... EXCEPTION WHEN duplicate_object pattern for idempotent enum creation
- Foreign key relationships use `@JoinColumn({ name: 'columnName' })` with explicit column naming
- Migration files are timestamped and must be in `src/migrations/` (compiled to `dist/migrations/`)
- Use `columnExists` check pattern to make migrations idempotent: `table?.columns.find((col) => col.name === 'columnName')`
- Always run `turbo run build --filter=backend` before running migrations
- Migration command: `cd apps/backend && yarn db:migrate`

---

## 2026-01-18 09:33 - US-001
- Created SyncHistory entity with all required fields (id, espConnectionId, status, startedAt, completedAt, errorMessage, createdAt)
- Added SyncHistoryStatus enum with 'success' and 'failed' values
- Added @ManyToOne relationship from SyncHistory to EspConnection
- Updated EspConnection entity to include @OneToMany relationship to SyncHistory
- Created migration 1737220000000-CreateSyncHistory.ts to create sync_history table with foreign key constraint
- Made existing AddSyncStatusToEspConnection migration idempotent by adding column existence check
- Files changed:
  - `apps/backend/src/entities/sync-history.entity.ts` - New entity file
  - `apps/backend/src/entities/esp-connection.entity.ts` - Added import and syncHistory relationship
  - `apps/backend/src/migrations/1737220000000-CreateSyncHistory.ts` - New migration file
  - `apps/backend/src/migrations/1737200000000-AddSyncStatusToEspConnection.ts` - Added idempotency check
- **Learnings for future iterations:**
  - The data-source.ts uses `src/**/*.entity.ts` pattern to auto-discover entities
  - When adding relationships, both entities need to be updated (ManyToOne side and OneToMany side)
  - Foreign key CASCADE delete ensures sync history is removed when connection is deleted
  - Existing migrations may need idempotency fixes if database already has changes applied
  - Migration timestamps should be sequential and higher than existing migrations
---

## 2026-01-18 10:15 - US-002
- Updated SubscriberSyncProcessor to create SyncHistory records for tracking sync operations
- Added SyncHistory repository injection to the processor
- Created sync history record at job start with status: 'success' and startedAt timestamp
- Updated sync history with completedAt timestamp when sync completes successfully
- Updated sync history with status: 'failed', completedAt, and errorMessage when sync fails after all retries
- Used BullMQ's job.attemptsMade and job.opts.attempts to detect final retry attempt
- Files changed:
  - `apps/backend/src/processors/subscriber-sync.processor.ts` - Added sync history tracking
- **Learnings for future iterations:**
  - BullMQ jobs have `attemptsMade` and `opts.attempts` properties to track retry attempts
  - When a job will be retried, we should only record final failure after all retries exhausted
  - Repository injection in processors follows same pattern as in services/controllers
  - Optimistic approach: Create sync history with 'success' status, update to 'failed' only if needed
  - Always wrap database updates in try-catch to prevent processor failures from cascading
---

## 2026-01-18 15:30 - US-003
- Created SyncHistoryService with findByEspConnection method
- Method queries sync history records for a specific ESP connection
- Returns records ordered by startedAt DESC (most recent first)
- Optional limit parameter defaults to 50 if not provided
- Includes ESP connection relationship in query using relations: ['espConnection']
- Registered SyncHistory entity in TypeOrmModule.forFeature()
- Registered SyncHistoryService in AppModule providers
- Files changed:
  - `apps/backend/src/services/sync-history.service.ts` - New service file
  - `apps/backend/src/app.module.ts` - Added SyncHistory entity and SyncHistoryService registration
- **Learnings for future iterations:**
  - Services follow standard NestJS pattern: @Injectable() decorator, constructor injection
  - Repository injection uses @InjectRepository(Entity) pattern
  - TypeORM find() options: where (filters), relations (eager load), order (sorting), take (limit)
  - Default parameter values in TypeScript: `limit: number = 50` syntax
  - Services must be registered in AppModule providers array to be injectable
  - Entities must be in TypeOrmModule.forFeature() array to inject their repositories
---
